exports.updateUser = (req, res) => {
  const userId = req.params.userId;
  const name = req.body.name;
  const email = req.body.email;
  let avatarImage;

  console.log(name);
  console.log(email);
  
  // If a new avatar image is uploaded, get its filename
  if (req.file) {
    avatarImage = req.file.filename;

    // Get the current avatar image to delete it after updating
    connection.query('SELECT avatar_image FROM users WHERE user_id = ?', [userId], (err, results) => {
      if (err) {
        console.error(err);
        return res.status(500).json({ message: 'Database query error' });
      }

      const currentAvatarImage = results[0].avatar_image;
      
      // Xóa ảnh cũ nếu tồn tại
      if (currentAvatarImage) {
        const filename = currentAvatarImage.split('/').pop(); // Lấy tên tệp từ đường dẫn
        fs.unlink(`uploads/${filename}`, (unlinkErr) => {
          if (unlinkErr) {
            // Nếu không tìm thấy tệp trong uploads, tiếp tục với cập nhật dữ liệu người dùng
            if (unlinkErr.code === 'ENOENT') {
              console.error('File not found in uploads:', unlinkErr);
              updateUserInDatabase(userId, name, email, avatarImage, res);
            } else {
              console.error('Error deleting image file:', unlinkErr);
              return res.status(500).json({ message: 'Internal server error' });
            }
          } else {
            // Nếu xóa thành công, tiếp tục với cập nhật dữ liệu người dùng
            updateUserInDatabase(userId, name, email, avatarImage, res);
          }
        });
      } else {
        // Nếu không có ảnh cũ, tiếp tục với cập nhật dữ liệu người dùng
        updateUserInDatabase(userId, name, email, avatarImage, res);
      }
    });
  } else {
    // Nếu không có ảnh mới được tải lên, tiếp tục với cập nhật dữ liệu người dùng
    updateUserInDatabase(userId, name, email, avatarImage, res);
  }
};

function updateUserInDatabase(userId, name, email, avatarImage, res) {
  // Update user info in the database
  let query = 'UPDATE users SET name = ?, email = ?';
  let values = [name, email];

  if (avatarImage) {
    query += ', avatar_image = ?';
    values.push(`http://172.16.3.80:3000/uploads/${avatarImage}`);
  }

  query += ' WHERE user_id = ?';
  values.push(userId);

  connection.query(query, values, (err, result) => {
    if (err) {
      console.error(err);
      return res.status(500).json({ message: 'Database update error' });
    }

    res.json({ message: 'User updated successfully' });
  });
}
